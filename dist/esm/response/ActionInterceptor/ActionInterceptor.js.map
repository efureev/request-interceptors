{"version":3,"file":"ActionInterceptor.js","names":["buildAction","ResponseWrapper","createResponseWrapper","OnlyOneActionError","HttpError","isNativeError","makeHttpError","defaultConfig","actionAttributeName","errHandler","interceptorConfig","configLayer","requestExtra","error","Promise","reject","e","data","action","response","run","getExtra","successHandler","rawData","isBinary","type","ActionInterceptor","layerConfig"],"sources":["../../../../src/response/ActionInterceptor/ActionInterceptor.ts"],"sourcesContent":["import type { AxiosError, AxiosResponse } from 'axios'\nimport { buildAction } from './actions'\nimport type { ExtraProperties, LayerConfig } from '@feugene/layer-request'\nimport ResponseWrapper from '../WrapperInterceptor/ResponseWrapper'\nimport { createResponseWrapper } from '../WrapperInterceptor/WrapperInterceptor'\nimport OnlyOneActionError from './actions/OnlyOneActionError'\nimport HttpError from '../../errors/HttpError'\nimport { isNativeError, makeHttpError } from '../../errors'\n\nconst defaultConfig: ActionInterceptorConfig = {\n  actionAttributeName: 'status',\n}\n\nexport interface ActionInterceptorConfig {\n  actionAttributeName: string\n}\n\nconst errHandler = (interceptorConfig: ActionInterceptorConfig, configLayer: LayerConfig, requestExtra: ExtraProperties) =>\n  (error: AxiosError | HttpError | Error) => {\n    if (isNativeError(error)) {\n      return Promise.reject(error)\n    }\n    const e: HttpError = error instanceof HttpError ? error : makeHttpError(<AxiosError>error)\n\n    if (e.data && e.data[interceptorConfig.actionAttributeName]) {\n      const action = buildAction(\n        e.data[interceptorConfig.actionAttributeName],\n        interceptorConfig,\n        requestExtra,\n      )\n\n      if (action && e.response) {\n        action.run(configLayer, e.response)\n        if (configLayer.getExtra('onlyOneAction')) {\n          throw new OnlyOneActionError(e.response)\n        }\n      }\n    }\n\n    return Promise.reject(e)\n  }\n\nconst successHandler = (interceptorConfig: ActionInterceptorConfig, configLayer: LayerConfig, requestExtra: ExtraProperties) =>\n  (response: AxiosResponse | ResponseWrapper) => {\n\n    if (!(response instanceof ResponseWrapper)) {\n      response = createResponseWrapper(<AxiosResponse>response, configLayer)\n    }\n\n    const rawData = !response.isBinary()\n      ? response.response.data[interceptorConfig.actionAttributeName]\n      : { type: 'blob' }\n\n    const action = buildAction(rawData, interceptorConfig, requestExtra)\n\n    if (action) {\n      // @ts-ignore\n      response.action = action\n\n      action.run(configLayer, response)\n\n      if (configLayer.getExtra('onlyOneAction')) {\n        throw new OnlyOneActionError(response.response)\n      }\n    }\n\n    return response\n  }\n\nconst ActionInterceptor = (interceptorConfig: ActionInterceptorConfig = defaultConfig) =>\n  (layerConfig: LayerConfig, requestExtra: ExtraProperties) =>\n    [\n      successHandler(interceptorConfig, layerConfig, requestExtra),\n      errHandler(interceptorConfig, layerConfig, requestExtra),\n    ]\n\nexport {\n  ActionInterceptor,\n}\n"],"mappings":"AACA,SAASA,WAAT,QAA4B,WAA5B;AAEA,OAAOC,eAAP,MAA4B,uCAA5B;AACA,SAASC,qBAAT,QAAsC,0CAAtC;AACA,OAAOC,kBAAP,MAA+B,8BAA/B;AACA,OAAOC,SAAP,MAAsB,wBAAtB;AACA,SAASC,aAAT,EAAwBC,aAAxB,QAA6C,cAA7C;AAEA,MAAMC,aAAsC,GAAG;EAC7CC,mBAAmB,EAAE;AADwB,CAA/C;;AAQA,MAAMC,UAAU,GAAG,CAACC,iBAAD,EAA6CC,WAA7C,EAAuEC,YAAvE,KAChBC,KAAD,IAA2C;EACzC,IAAIR,aAAa,CAACQ,KAAD,CAAjB,EAA0B;IACxB,OAAOC,OAAO,CAACC,MAAR,CAAeF,KAAf,CAAP;EACD;;EACD,MAAMG,CAAY,GAAGH,KAAK,YAAYT,SAAjB,GAA6BS,KAA7B,GAAqCP,aAAa,CAAaO,KAAb,CAAvE;;EAEA,IAAIG,CAAC,CAACC,IAAF,IAAUD,CAAC,CAACC,IAAF,CAAOP,iBAAiB,CAACF,mBAAzB,CAAd,EAA6D;IAC3D,MAAMU,MAAM,GAAGlB,WAAW,CACxBgB,CAAC,CAACC,IAAF,CAAOP,iBAAiB,CAACF,mBAAzB,CADwB,EAExBE,iBAFwB,EAGxBE,YAHwB,CAA1B;;IAMA,IAAIM,MAAM,IAAIF,CAAC,CAACG,QAAhB,EAA0B;MACxBD,MAAM,CAACE,GAAP,CAAWT,WAAX,EAAwBK,CAAC,CAACG,QAA1B;;MACA,IAAIR,WAAW,CAACU,QAAZ,CAAqB,eAArB,CAAJ,EAA2C;QACzC,MAAM,IAAIlB,kBAAJ,CAAuBa,CAAC,CAACG,QAAzB,CAAN;MACD;IACF;EACF;;EAED,OAAOL,OAAO,CAACC,MAAR,CAAeC,CAAf,CAAP;AACD,CAvBH;;AAyBA,MAAMM,cAAc,GAAG,CAACZ,iBAAD,EAA6CC,WAA7C,EAAuEC,YAAvE,KACpBO,QAAD,IAA+C;EAE7C,IAAI,EAAEA,QAAQ,YAAYlB,eAAtB,CAAJ,EAA4C;IAC1CkB,QAAQ,GAAGjB,qBAAqB,CAAgBiB,QAAhB,EAA0BR,WAA1B,CAAhC;EACD;;EAED,MAAMY,OAAO,GAAG,CAACJ,QAAQ,CAACK,QAAT,EAAD,GACZL,QAAQ,CAACA,QAAT,CAAkBF,IAAlB,CAAuBP,iBAAiB,CAACF,mBAAzC,CADY,GAEZ;IAAEiB,IAAI,EAAE;EAAR,CAFJ;EAIA,MAAMP,MAAM,GAAGlB,WAAW,CAACuB,OAAD,EAAUb,iBAAV,EAA6BE,YAA7B,CAA1B;;EAEA,IAAIM,MAAJ,EAAY;IACV;IACAC,QAAQ,CAACD,MAAT,GAAkBA,MAAlB;IAEAA,MAAM,CAACE,GAAP,CAAWT,WAAX,EAAwBQ,QAAxB;;IAEA,IAAIR,WAAW,CAACU,QAAZ,CAAqB,eAArB,CAAJ,EAA2C;MACzC,MAAM,IAAIlB,kBAAJ,CAAuBgB,QAAQ,CAACA,QAAhC,CAAN;IACD;EACF;;EAED,OAAOA,QAAP;AACD,CAzBH;;AA2BA,MAAMO,iBAAiB,GAAG,CAAChB,iBAA0C,GAAGH,aAA9C,KACxB,CAACoB,WAAD,EAA2Bf,YAA3B,KACE,CACEU,cAAc,CAACZ,iBAAD,EAAoBiB,WAApB,EAAiCf,YAAjC,CADhB,EAEEH,UAAU,CAACC,iBAAD,EAAoBiB,WAApB,EAAiCf,YAAjC,CAFZ,CAFJ;;AAOA,SACEc,iBADF"}