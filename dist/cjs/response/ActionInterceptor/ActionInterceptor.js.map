{"version":3,"file":"ActionInterceptor.js","names":["defaultConfig","actionAttributeName","errHandler","interceptorConfig","configLayer","requestExtra","error","isNativeError","Promise","reject","e","HttpError","makeHttpError","data","action","buildAction","response","run","getExtra","OnlyOneActionError","successHandler","ResponseWrapper","createResponseWrapper","rawData","isBinary","type","ActionInterceptor","layerConfig"],"sources":["../../../../src/response/ActionInterceptor/ActionInterceptor.ts"],"sourcesContent":["import type { AxiosError, AxiosResponse } from 'axios'\nimport { buildAction } from './actions'\nimport type { ExtraProperties, LayerConfig } from '@feugene/layer-request'\nimport ResponseWrapper from '../WrapperInterceptor/ResponseWrapper'\nimport { createResponseWrapper } from '../WrapperInterceptor/WrapperInterceptor'\nimport OnlyOneActionError from './actions/OnlyOneActionError'\nimport HttpError from '../../errors/HttpError'\nimport { isNativeError, makeHttpError } from '../../errors'\n\nconst defaultConfig: ActionInterceptorConfig = {\n  actionAttributeName: 'status',\n}\n\nexport interface ActionInterceptorConfig {\n  actionAttributeName: string\n}\n\nconst errHandler = (interceptorConfig: ActionInterceptorConfig, configLayer: LayerConfig, requestExtra: ExtraProperties) =>\n  (error: AxiosError | HttpError | Error) => {\n    if (isNativeError(error)) {\n      return Promise.reject(error)\n    }\n    const e: HttpError = error instanceof HttpError ? error : makeHttpError(<AxiosError>error)\n\n    if (e.data && e.data[interceptorConfig.actionAttributeName]) {\n      const action = buildAction(\n        e.data[interceptorConfig.actionAttributeName],\n        interceptorConfig,\n        requestExtra,\n      )\n\n      if (action && e.response) {\n        action.run(configLayer, e.response)\n        if (configLayer.getExtra('onlyOneAction')) {\n          throw new OnlyOneActionError(e.response)\n        }\n      }\n    }\n\n    return Promise.reject(e)\n  }\n\nconst successHandler = (interceptorConfig: ActionInterceptorConfig, configLayer: LayerConfig, requestExtra: ExtraProperties) =>\n  (response: AxiosResponse | ResponseWrapper) => {\n\n    if (!(response instanceof ResponseWrapper)) {\n      response = createResponseWrapper(<AxiosResponse>response, configLayer)\n    }\n\n    const rawData = !response.isBinary()\n      ? response.response.data[interceptorConfig.actionAttributeName]\n      : { type: 'blob' }\n\n    const action = buildAction(rawData, interceptorConfig, requestExtra)\n\n    if (action) {\n      // @ts-ignore\n      response.action = action\n\n      action.run(configLayer, response)\n\n      if (configLayer.getExtra('onlyOneAction')) {\n        throw new OnlyOneActionError(response.response)\n      }\n    }\n\n    return response\n  }\n\nconst ActionInterceptor = (interceptorConfig: ActionInterceptorConfig = defaultConfig) =>\n  (layerConfig: LayerConfig, requestExtra: ExtraProperties) =>\n    [\n      successHandler(interceptorConfig, layerConfig, requestExtra),\n      errHandler(interceptorConfig, layerConfig, requestExtra),\n    ]\n\nexport {\n  ActionInterceptor,\n}\n"],"mappings":";;;;;;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;;;AAEA,IAAMA,aAAsC,GAAG;EAC7CC,mBAAmB,EAAE;AADwB,CAA/C;;AAQA,IAAMC,UAAU,GAAG,SAAbA,UAAa,CAACC,iBAAD,EAA6CC,WAA7C,EAAuEC,YAAvE;EAAA,OACjB,UAACC,KAAD,EAA2C;IACzC,IAAI,IAAAC,qBAAA,EAAcD,KAAd,CAAJ,EAA0B;MACxB,OAAOE,OAAO,CAACC,MAAR,CAAeH,KAAf,CAAP;IACD;;IACD,IAAMI,CAAY,GAAGJ,KAAK,YAAYK,kBAAjB,GAA6BL,KAA7B,GAAqC,IAAAM,qBAAA,EAA0BN,KAA1B,CAA1D;;IAEA,IAAII,CAAC,CAACG,IAAF,IAAUH,CAAC,CAACG,IAAF,CAAOV,iBAAiB,CAACF,mBAAzB,CAAd,EAA6D;MAC3D,IAAMa,MAAM,GAAG,IAAAC,oBAAA,EACbL,CAAC,CAACG,IAAF,CAAOV,iBAAiB,CAACF,mBAAzB,CADa,EAEbE,iBAFa,EAGbE,YAHa,CAAf;;MAMA,IAAIS,MAAM,IAAIJ,CAAC,CAACM,QAAhB,EAA0B;QACxBF,MAAM,CAACG,GAAP,CAAWb,WAAX,EAAwBM,CAAC,CAACM,QAA1B;;QACA,IAAIZ,WAAW,CAACc,QAAZ,CAAqB,eAArB,CAAJ,EAA2C;UACzC,MAAM,IAAIC,2BAAJ,CAAuBT,CAAC,CAACM,QAAzB,CAAN;QACD;MACF;IACF;;IAED,OAAOR,OAAO,CAACC,MAAR,CAAeC,CAAf,CAAP;EACD,CAvBgB;AAAA,CAAnB;;AAyBA,IAAMU,cAAc,GAAG,SAAjBA,cAAiB,CAACjB,iBAAD,EAA6CC,WAA7C,EAAuEC,YAAvE;EAAA,OACrB,UAACW,QAAD,EAA+C;IAE7C,IAAI,EAAEA,QAAQ,YAAYK,wBAAtB,CAAJ,EAA4C;MAC1CL,QAAQ,GAAG,IAAAM,yCAAA,EAAqCN,QAArC,EAA+CZ,WAA/C,CAAX;IACD;;IAED,IAAMmB,OAAO,GAAG,CAACP,QAAQ,CAACQ,QAAT,EAAD,GACZR,QAAQ,CAACA,QAAT,CAAkBH,IAAlB,CAAuBV,iBAAiB,CAACF,mBAAzC,CADY,GAEZ;MAAEwB,IAAI,EAAE;IAAR,CAFJ;IAIA,IAAMX,MAAM,GAAG,IAAAC,oBAAA,EAAYQ,OAAZ,EAAqBpB,iBAArB,EAAwCE,YAAxC,CAAf;;IAEA,IAAIS,MAAJ,EAAY;MACV;MACAE,QAAQ,CAACF,MAAT,GAAkBA,MAAlB;MAEAA,MAAM,CAACG,GAAP,CAAWb,WAAX,EAAwBY,QAAxB;;MAEA,IAAIZ,WAAW,CAACc,QAAZ,CAAqB,eAArB,CAAJ,EAA2C;QACzC,MAAM,IAAIC,2BAAJ,CAAuBH,QAAQ,CAACA,QAAhC,CAAN;MACD;IACF;;IAED,OAAOA,QAAP;EACD,CAzBoB;AAAA,CAAvB;;AA2BA,IAAMU,iBAAiB,GAAG,SAApBA,iBAAoB;EAAA,IAACvB,iBAAD,uEAA8CH,aAA9C;EAAA,OACxB,UAAC2B,WAAD,EAA2BtB,YAA3B;IAAA,OACE,CACEe,cAAc,CAACjB,iBAAD,EAAoBwB,WAApB,EAAiCtB,YAAjC,CADhB,EAEEH,UAAU,CAACC,iBAAD,EAAoBwB,WAApB,EAAiCtB,YAAjC,CAFZ,CADF;EAAA,CADwB;AAAA,CAA1B"}